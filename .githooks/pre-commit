#!/bin/bash
# Pre-commit hook for Fractalaw validation
# Implements Phase 1 of shift-left CI/CD strategy
# Fast checks only — must complete in seconds, not minutes

# Ensure cargo is on PATH (rustup installs to ~/.cargo/bin)
export PATH="$HOME/.cargo/bin:$PATH"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

EXIT_CODE=0

print_header() {
    echo -e "\n${CYAN}═══════════════════════════════════════════════════════${NC}"
    echo -e "${CYAN}  Pre-Commit Validation (Shift-Left CI/CD)${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════════════════${NC}\n"
}

print_status()  { echo -e "${BLUE}[Check]${NC} $1"; }
print_success() { echo -e "${GREEN}[✓]${NC} $1"; }
print_warning() { echo -e "${YELLOW}[!]${NC} $1"; }
print_error()   { echo -e "${RED}[✗]${NC} $1"; }
print_info()    { echo -e "${CYAN}[i]${NC} $1"; }

# Check that cargo is available
check_cargo_available() {
    if ! command -v cargo > /dev/null 2>&1; then
        print_error "cargo not found — is Rust installed via rustup?"
        print_info "Install: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh"
        exit 1
    fi
}

# Check 1: Code Formatting
check_formatting() {
    print_status "Checking code formatting (cargo fmt)..."

    # Check if any .rs files are staged
    STAGED_RS=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$' || true)
    if [ -z "$STAGED_RS" ]; then
        print_info "No Rust files staged for commit"
        return 0
    fi

    FMT_OUTPUT=$(cargo fmt --all -- --check 2>&1)
    if [ $? -ne 0 ]; then
        print_error "Code is not formatted"
        echo "$FMT_OUTPUT"
        print_info "Run 'cargo fmt' to fix"
        return 1
    fi

    print_success "Code formatting is correct"
    return 0
}

# Check 2: Compilation
check_compilation() {
    print_status "Checking compilation (cargo check)..."

    CHECK_OUTPUT=$(cargo check --workspace 2>&1)
    if [ $? -ne 0 ]; then
        print_error "Compilation failed"
        echo "$CHECK_OUTPUT"
        return 1
    fi

    # Check for warnings
    if echo "$CHECK_OUTPUT" | grep -q "^warning\["; then
        print_warning "Compilation succeeded with warnings"
        echo "$CHECK_OUTPUT" | grep "^warning\["
    else
        print_success "Compilation successful (no warnings)"
    fi
    return 0
}

# Check 3: Clippy (static analysis — Rust's Credo equivalent)
check_clippy() {
    print_status "Running static analysis (cargo clippy)..."

    CLIPPY_OUTPUT=$(cargo clippy --workspace -- -D warnings 2>&1)
    if [ $? -ne 0 ]; then
        print_error "Clippy found issues"
        echo "$CLIPPY_OUTPUT"
        print_info "Fix issues or apply suggestions with 'cargo clippy --fix'"
        return 1
    fi

    print_success "Static analysis passed (no warnings)"
    return 0
}

# Main execution
main() {
    print_header
    check_cargo_available

    STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
    if [ -z "$STAGED_FILES" ]; then
        print_warning "No files staged for commit"
        exit 0
    fi

    print_info "Running pre-commit checks on staged files..."
    echo ""

    check_formatting || EXIT_CODE=1
    echo ""

    check_compilation || EXIT_CODE=1
    echo ""

    check_clippy || EXIT_CODE=1
    echo ""

    echo -e "${CYAN}═══════════════════════════════════════════════════════${NC}"

    if [ $EXIT_CODE -eq 0 ]; then
        print_success "All pre-commit checks passed!"
        echo -e "${CYAN}═══════════════════════════════════════════════════════${NC}\n"
        exit 0
    else
        print_error "Pre-commit checks failed"
        print_info "Fix the issues above and try again"
        print_warning "To bypass: git commit --no-verify (not recommended)"
        echo -e "${CYAN}═══════════════════════════════════════════════════════${NC}\n"
        exit 1
    fi
}

main
